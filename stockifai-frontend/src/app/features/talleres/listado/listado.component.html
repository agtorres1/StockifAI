<div class="card shadow-sm">
    <div class="card-body p-3">

        <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Talleres</h5>
            <button type="button" class="btn btn-primary ms-auto d-flex align-items-center gap-1" data-bs-toggle="modal"
                data-bs-target="#crearTallerModal" (click)="openCrearTallerDialog()">
                <i class="fa fa-circle-plus me-1"></i>
                Nuevo taller
            </button>
        </div>
        <hr>

        <div *ngIf="loading" class="alert alert-info d-flex justify-content-center align-items-center mb-2 p-2">
            <div class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></div>
            <span>Cargando…</span>
        </div>

        <div *ngIf="errorMessage" class="alert alert-danger alert-dismissible fade show mt-2 mb-2 p-2" role="alert">
            <span class="text-sm">{{ errorMessage }}</span>
        </div>

        <div class="table-responsive" *ngIf="!loading">
            <table class="table table-bordered table-hover align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th>ID</th>
                        <th>Nombre</th>
                        <th>Dirección</th>
                        <th>Teléfono</th>
                        <th>Email</th>
                        <th>Fecha de Creación</th>
                        <th style="width:50px; white-space:nowrap;">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let taller of talleres">
                        <td>{{ taller.id }}</td>
                        <td>{{ taller.nombre }}</td>
                        <td>{{ taller.direccion }}</td>
                        <td>{{ taller.telefono }}</td>
                        <td>{{ taller.email }}</td>
                        <td>{{ taller.fecha_creacion | date }}</td>
                        <td>
                            <div class="d-inline-flex align-items-center gap-1">
                                <button class="btn btn-sm" data-bs-toggle="tooltip" data-bs-placement="bottom"
                                    title="Editar" (click)="onEditTallerClick(taller)">
                                    <i class="fa fa-pencil me-1"></i>
                                </button>
                                <button class="btn btn-sm" data-bs-toggle="tooltip" data-bs-placement="bottom"
                                    title="Eliminar" (click)="onDeleteTallerClick(taller)">
                                    <i class="fa fa-trash me-1"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    <tr *ngIf="talleres.length === 0">
                        <td colspan="7" class="text-center text-muted py-3">No hay talleres para mostrar.</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>


<div class="modal fade" id="crearTallerModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <form class="modal-content" #tallerForm="ngForm" (ngSubmit)="submitTallerForm(tallerForm)" novalidate>
            <div class="modal-header">
                <h5 class="modal-title">{{ isEditMode ? 'Editar taller' : 'Crear nuevo taller' }}</h5>

                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"
                    (click)="closeCrearTallerDialog(true)"></button>
            </div>

            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label fs-6">Nombre <span class="text-danger">*</span></label>
                    <input #nombre="ngModel" type="text" class="form-control" name="nombre"
                        [(ngModel)]="nuevoTaller.nombre" required maxlength="150"
                        [ngClass]="{'is-invalid': tallerForm.submitted && nombre.invalid}" />
                    <div class="invalid-feedback d-block" *ngIf="tallerForm.submitted && nombre.invalid">
                        El nombre es requerido.
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label fs-6">Dirección <span class="text-danger">*</span></label>
                    <input #direccion="ngModel" type="text" class="form-control" name="direccion"
                        [(ngModel)]="nuevoTaller.direccion" required maxlength="255"
                        [ngClass]="{'is-invalid': tallerForm.submitted && direccion.invalid}" />
                    <div class="invalid-feedback d-block" *ngIf="tallerForm.submitted && direccion.invalid">
                        La dirección es requerida.
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label fs-6">Teléfono <span class="text-danger">*</span></label>
                    <input #telefono="ngModel" type="text" class="form-control" name="telefono"
                        [(ngModel)]="nuevoTaller.telefono" required maxlength="50"
                        [ngClass]="{'is-invalid': tallerForm.submitted && telefono.invalid}" />
                    <div class="invalid-feedback d-block" *ngIf="tallerForm.submitted && telefono.invalid">
                        El teléfono es requerido.
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label fs-6">Email <span class="text-danger">*</span></label>
                    <input type="email" class="form-control" name="email" [(ngModel)]="nuevoTaller.email" required email
                        pattern="^[^@\s]+@[^@\s]+\.[^@\s]{2,}$" #email="ngModel"
                        [ngClass]="{'is-invalid': tallerForm.submitted && email.invalid}" maxlength="254" />

                    <div class="invalid-feedback d-block" *ngIf="tallerForm.submitted && email.invalid">
                        <ng-container *ngIf="email.errors?.['required']">
                            El email es requerido.
                        </ng-container>
                        <ng-container *ngIf="email.errors?.['email'] || email.errors?.['pattern']">
                            Ingresá un email válido.
                        </ng-container>
                    </div>
                </div>

                <div *ngIf="dialogErrorMessage" class="alert alert-danger mt-3">{{ dialogErrorMessage }}</div>
                <div *ngIf="dialogSuccessMessage" class="alert alert-success mt-3">{{ dialogSuccessMessage }}</div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal"
                    (click)="closeCrearTallerDialog()">Cancelar</button>
                <button type="submit" class="btn btn-primary" [disabled]="dialogLoading">
                    <div *ngIf="dialogLoading" class="spinner-border spinner-border-sm me-2" role="status"
                        aria-hidden="true"></div>
                    {{ dialogLoading ? (isEditMode ? 'Guardando...' : 'Creando...') : (isEditMode ? 'Guardar cambios' :
                    'Crear taller') }}
                </button>
            </div>
        </form>
    </div>
</div>


<div class="modal fade" id="deleteTallerModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Eliminar taller</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <p class="mb-1">
                    ¿Seguro que querés eliminar el taller
                    <strong>{{ selectedTaller?.nombre }}</strong> (ID {{ selectedTaller?.id }})?
                </p>
                <small class="text-muted">Esta acción no se puede deshacer.</small>

                <div *ngIf="deleteErrorMessage" class="alert alert-danger mt-3">{{ deleteErrorMessage }}</div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    Cancelar
                </button>
                <button type="button" class="btn btn-danger" (click)="deleteTaller()" [disabled]="deleting">
                    <div *ngIf="deleting" class="spinner-border spinner-border-sm me-2" role="status"
                        aria-hidden="true"></div>
                    {{ deleting ? 'Eliminando...' : 'Eliminar' }}
                </button>
            </div>
        </div>
    </div>
</div>